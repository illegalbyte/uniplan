{% extends 'app_uniplan/base.html' %}


{% block content %}

<h1>Your upcoming assignments</h1>

<a href="{% url "add_all_missing_assignments" %}"><button class="btn btn-warning">Click to add <b>{{total_assignments_count}} Tasks</b> Not yet added</button></a>


<table id="assignments" class="table table-striped table-bordered">
	<thead>
		<tr>
			<th>Edit</th>
			<th>Unit</th>
			<th>Assignment</th>
			<th>Due Week</th>
			<th>Due Week (#)</th>
			<th>Due Date</th>
			<th>Status</th>
		</tr>
	</thead>
	<tbody>
		{% for assignment in assignments %}
		<tr>
			<td><center><a href="{{ assignment.id }}"><i class="fa-solid fa-pen-to-square"></i></a></center></td>
			<td>{{ assignment.unit }}</td>
			<td><a href="{{ assignment.id }}">{{ assignment.title }}</a></td>
			<td>{{ assignment.due_week_text }}</td>
			<td class="editable" data-id="{{ assignment.id }}" data-type="due_week_number">{{ assignment.due_week_number }}</td>
			<td>{{ assignment.due_date }}</td>
			<td>{{ assignment.status }}</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
<script>
{% comment %} var editor = new $.fn.dataTable.Editor( {
    ajax:  '/api/staff',
    table: '#assignments',
    fields: [
		{label : "Unit", name: "unit_code"},
		{label: "Title", name: "title"},
		{label: "Due Week", name: "due_week"},
		{label: "Due Date", name: "due_date"},
		{label: "Status", name: "status"},
    ]
} ); {% endcomment %}

$(document).ready(function() {
    $('#assignments').DataTable({
		"order": [[ 2, "des" ]],
		"paging": false,
		"info": false,
	});
}); 

</script>

    <script>
        $(document).ready(function(){
            $(document).on("click",".editable",function(){
                var value=$(this).text();
                var data_type=$(this).data("type");
                var input_type="text";
                if(data_type=="created_at")
                {
                    input_type="datetime-local";
                }
                var input="<input type='"+input_type+"' class='input-data' value='"+value+"' class='form-control'>";
                $(this).html(input);
                $(this).removeClass("editable")
            });

            $(document).on("blur",".input-data",function(){
                var value=$(this).val();
                var td=$(this).parent("td");
                $(this).remove();
                td.html(value);
                td.addClass("editable");
                var type=td.data("type");
                sendToServer(td.data("id"),value,type);
            });
            $(document).on("keypress",".input-data",function(e){
                var key=e.which;
                if(key==13){
                    var value=$(this).val();
                    var td=$(this).parent("td");
                    $(this).remove();
                    td.html(value);
                    td.addClass("editable");
                   var type=td.data("type")
                   sendToServer(td.data("id"),value,type);
                }
            });

            function sendToServer(id,value,type){
				console.log(id);
                console.log(value);
                console.log(type);
				var ajax_data = {
					'csrfmiddlewaretoken': '{{ csrf_token }}',
					'id': id, 
				}
				ajax_data[type] = value;
                $.ajax({
                    url: `{% url "assignment_api" %}?pk={id}`,
                    type:"PATCH",
					headers: {
						'X-CSRFToken': '{{ csrf_token }}'
					},
                    data: ajax_data,
                })
                .done(function(response){
                    console.log(response);
                })
                .fail(function(){
                   console.log("Error Occured");
                });
            }
        });

</script>

<hr>
<details><summary>Add an assignment manually</summary>
<h1>Add an assignment</h1>
<form method="POST">
	{% csrf_token %}
	{{ form.as_p }}
	<button type="submit" class="btn btn-primary">Add</button>
</form>
<details>
{% endblock %}